<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Official Survey | Proof of Action</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for aesthetics -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Hind+Siliguri:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', 'Hind Siliguri', sans-serif;
            background-color: #f8fafc;
        }

        .camera-container {
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: #000;
        }
    </style>
</head>
<body onload="lucide.createIcons()">

    <!-- Navbar -->
    <header class="bg-indigo-900 shadow-xl text-white p-4 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center">
            <div class="logo flex items-center mb-4 md:mb-0">
                <i data-lucide="school" class="w-8 h-8 mr-3 text-yellow-300"></i>
                <h2 class="text-xl font-bold font-['Hind Siliguri']">विद्यालय अवसंरचना निगरानी प्रणाली</h2>
            </div>
            <nav>
                <ul class="flex space-x-4 md:space-x-8 text-sm md:text-base font-medium">
                    <li><a href="index.html" class="hover:text-yellow-300 transition duration-150">मुखपृष्ठ</a></li>
                    <li><a href="status.html" class="hover:text-yellow-300 transition duration-150">स्कूल स्थिति</a></li>
                    <li><a href="report.html" class="hover:text-yellow-300 transition duration-150">रिपोर्ट</a></li>
                    <li><a href="feedback.html" class="hover:text-yellow-300 transition duration-150">फीडबैक</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Officer Survey Section -->
    <section class="max-w-4xl mx-auto p-6 md:p-10 my-10 bg-white rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold text-blue-700 mb-2 flex items-center">
            <i data-lucide="shield-check" class="w-7 h-7 mr-3"></i>
            अधिकारी सत्यापन रिपोर्ट (कार्रवाई का प्रमाण)
        </h1>
        <p class="text-gray-600 mb-6">कृपया की गई कार्रवाई को सत्यापित करें और प्रमाण के लिए एक लाइव तस्वीर कैप्चर करें।</p>

        <div id="complaintDetails" class="p-4 bg-blue-50 border border-blue-300 rounded-lg mb-6">
            <h2 class="text-xl font-bold text-blue-800">शिकायत ID: <span id="displayId">C001</span> (सिम्युलेटेड)</h2>
            <p class="text-md text-gray-700">स्कूल का नाम: गवर्नमेंट स्कूल, लखनऊ</p>
            <p class="text-md text-gray-700">समस्या: टूटे हुए फर्नीचर और बिजली की खुली तारें।</p>
        </div>

        <form id="surveyForm" onsubmit="submitSurvey(event)">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="officerId" class="block text-sm font-medium text-gray-700 mb-1">अधिकारी ID/नाम:</label>
                    <input type="text" id="officerId" placeholder="अपनी ID दर्ज करें" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                </div>
                <div>
                    <label for="actionStatus" class="block text-sm font-medium text-gray-700 mb-1">कार्रवाई की स्थिति:</label>
                    <select id="actionStatus" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm bg-white">
                        <option value="">स्थिति चुनें</option>
                        <option value="Completed">कार्रवाई पूरी हुई</option>
                        <option value="InProgress">कार्य प्रगति पर है</option>
                        <option value="NeedsMore">अधिक कार्रवाई की आवश्यकता है</option>
                    </select>
                </div>
            </div>

            <div class="mt-4">
                <label for="findings" class="block text-sm font-medium text-gray-700 mb-1">अधिकारी के निष्कर्ष:</label>
                <textarea id="findings" rows="4" placeholder="कार्रवाई के बारे में विस्तृत निष्कर्ष दर्ज करें..." required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm"></textarea>
            </div>
            
            <!-- Live Webcam Capture for Proof -->
            <div class="mt-4 p-4 border border-blue-300 rounded-lg bg-blue-50">
                <label class="block text-sm font-bold text-blue-700 mb-2 flex items-center">
                    <i data-lucide="gavel" class="w-5 h-5 mr-2"></i>
                    कार्रवाई का प्रमाण (लाइव फोटो)
                </label>
                
                <div id="camera-controls" class="mb-3">
                    <button type="button" onclick="startCamera()" id="startButton" class="w-full md:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                        कैमरा शुरू करें
                    </button>
                </div>
                
                <div id="camera-view" class="hidden">
                    <div class="camera-container mb-3 relative">
                        <video id="videoElement" class="w-full h-auto rounded-lg" autoplay playsinline></video>
                        <canvas id="canvasElement" class="hidden"></canvas>
                    </div>
                    
                    <button type="button" onclick="capturePhoto()" class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 flex items-center justify-center">
                        <i data-lucide="camera" class="w-5 h-5 mr-2"></i>
                        फोटो कैप्चर करें
                    </button>
                    
                    <div id="photoPreview" class="mt-4 hidden p-2 border border-green-300 bg-green-50 rounded-lg">
                        <p class="text-sm font-medium text-green-700">फोटो सफलतापूर्वक कैप्चर की गई!</p>
                        <img id="capturedImage" class="mt-2 w-full max-h-64 object-contain rounded-lg border border-green-400">
                        <input type="hidden" id="photoData" required>
                    </div>
                </div>
            </div>

            <button type="submit" class="w-full mt-8 py-3 px-6 bg-blue-600 text-white font-bold rounded-lg shadow-xl hover:bg-blue-700 transition duration-300 transform hover:scale-[1.01]">
                सत्यापन रिपोर्ट सबमिट करें
            </button>
        </form>
    </section>

    <!-- Footer -->
    <footer class="p-8 text-center bg-gray-800 text-gray-300 mt-10">
        <p class="text-sm">© 2025 Government of Uttar Pradesh | AI & IoT Monitoring Initiative</p>
    </footer>

    <!-- Custom Script (Officer Webcam Logic) -->
    <script>
        let videoStream;
        const videoElement = document.getElementById('videoElement');
        const canvasElement = document.getElementById('canvasElement');
        const photoDataInput = document.getElementById('photoData');
        const cameraView = document.getElementById('camera-view');
        const startButton = document.getElementById('startButton');

        document.addEventListener('DOMContentLoaded', () => {
            // Simulate reading complaint ID from URL (e.g., from status.html link)
            const urlParams = new URLSearchParams(window.location.search);
            const complaintId = urlParams.get('id') || 'C001';
            
            // Update displayed details (Simulated)
            document.getElementById('displayId').textContent = complaintId;

            lucide.createIcons();
        });

        async function startCamera() {
            startButton.disabled = true;
            startButton.textContent = 'कैमरा शुरू हो रहा है...';
            try {
                // Request access to the user's camera, prioritizing the environmental (rear) camera
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                videoElement.srcObject = videoStream;
                
                videoElement.onloadedmetadata = () => {
                    cameraView.classList.remove('hidden');
                    startButton.classList.add('hidden');
                };

            } catch (err) {
                console.error("Error accessing the camera: ", err);
                // Note: Using window.alert for a critical browser permission issue, as per standard HTML constraints in this environment.
                window.alert('कैमरा एक्सेस करने में त्रुटि। कृपया सुनिश्चित करें कि आपने अनुमति दी है।');
                startButton.textContent = 'कैमरा शुरू करें';
                startButton.disabled = false;
            }
        }

        function capturePhoto() {
            if (!videoStream) {
                window.alert('पहले कैमरा शुरू करें।');
                return;
            }

            // Set canvas dimensions to match video
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;

            // Draw the current video frame onto the canvas
            const context = canvasElement.getContext('2d');
            context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);

            // Convert canvas content to base64 image data (PNG format)
            const imageDataURL = canvasElement.toDataURL('image/png');
            
            // Display preview and store data
            document.getElementById('capturedImage').src = imageDataURL;
            photoDataInput.value = imageDataURL;
            document.getElementById('photoPreview').classList.remove('hidden');

            // Stop stream after capture
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
            cameraView.classList.add('hidden');
            startButton.classList.remove('hidden');
            startButton.textContent = 'कैमरा शुरू करें';
            startButton.disabled = false;
        }

        function submitSurvey(event) {
            event.preventDefault();
            const photoData = document.getElementById('photoData').value;
            const actionStatus = document.getElementById('actionStatus').value;
            
            if (!photoData) {
                window.alert("कृपया कार्रवाई के प्रमाण के रूप में एक फोटो कैप्चर करें।");
                return;
            }

            // In a real app, this data would update the original complaint status and be saved to Firestore.
            console.log("--- Officer Survey Submitted (Simulated) ---");
            console.log("Complaint ID:", document.getElementById('displayId').textContent);
            console.log("Officer ID:", document.getElementById('officerId').value);
            console.log("Action Status:", actionStatus);
            console.log("Findings:", document.getElementById('findings').value);
            
            // Reset form fields
            document.getElementById('surveyForm').reset();
            document.getElementById('photoPreview').classList.add('hidden');
            
            window.alert('सत्यापन रिपोर्ट सफलतापूर्वक सबमिट कर दी गई है! धन्यवाद।');
        }
    </script>
</body>
</html>
